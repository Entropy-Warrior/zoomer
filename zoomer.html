<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Zoomer's Sliders - With Slide Management</title>
<style>
  html, body {
    margin: 0; 
    padding: 0; 
    height: 100%; 
    overflow: hidden;
  }
  #openseadragon {
    width: 100%;
    height: 100%;
    position: relative;
    background: #333;
  }
  .selection-rectangle {
    position: absolute;
    border: 2px dashed #00ff00;
    pointer-events: none;
    display: none;
    z-index: 9999;
  }
  #overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events:none;
    z-index: 5000;
  }

  /* Toolbar styling */
  .toolbar {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 9999;
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 4px;
    font-size: 14px;
    color: #fff;
    width: 250px;
  }
  .toolbar button, .toolbar input[type="file"], .toolbar input[type="text"] {
    display: block;
    margin-bottom: 5px;
    background: #444;
    color: #fff;
    border: 1px solid #666;
    padding: 5px;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
  }
  .toolbar button:hover {
    background: #555;
  }
  .toolbar-section {
    margin-bottom: 15px;
  }
  .toolbar-section h3 {
    margin: 0 0 5px 0;
    font-size: 16px;
  }

  .slide-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  .slide-item input[type="text"] {
    flex: 1;
    margin-right: 5px;
    padding: 3px;
    background: #222;
    color: #fff;
    border: 1px solid #333;
  }
  .slide-controls button {
    width: auto;
    margin-right: 2px;
    padding: 3px 5px;
  }

  /* Toggle UI button always visible */
  #toggleUIBtn {
    position: absolute; 
    top: 10px; 
    left: 10px; 
    z-index: 10000; 
    background: #888; 
    color: #fff; 
    border: none; 
    padding: 5px; 
    cursor: pointer;
    border-radius: 4px;
  }
  #toggleUIBtn:hover {
    background: #777;
  }
</style>
<script src="openseadragon.min.js"></script>
</head>
<body>
<div id="openseadragon"></div>
<div class="selection-rectangle" id="selectionRect"></div>
<canvas id="overlayCanvas"></canvas>

<!-- Toolbar for UI-based controls -->
<div class="toolbar" id="toolbar">
  <div class="toolbar-section">
    <h3>Image & Settings</h3>
    <label>Load Image:</label>
    <input type="file" id="imageLoader" accept="image/*" />

    <label>Load Settings (JSON):</label>
    <input type="file" id="settingsLoader" accept=".json" />

    <button id="finalizeBtn" disabled>Finalize Regions</button>
    <button id="presentationBtn" disabled>Enter Presentation</button>
    <button id="saveBtn" disabled>Save Settings</button>
    <button id="clearBtn" disabled>Clear All</button>
  </div>

  <div class="toolbar-section">
    <h3>Slides</h3>
    <div id="slidesList">
      <!-- Dynamically populated with slide items -->
    </div>
  </div>
</div>

<!-- Always visible toggle button for UI -->
<button id="toggleUIBtn">Hide UI</button>

<script>
// Global variables
var viewer, tiledImage;
var selectionRectElement = document.getElementById('selectionRect');
var overlayCanvas = document.getElementById('overlayCanvas');
var overlayCtx = overlayCanvas.getContext('2d');
var toolbar = document.getElementById('toolbar');
var toggleUIBtn = document.getElementById('toggleUIBtn');

var editMode = true;         
var views = [];    // Each element: {x,y,w,h,name:"Slide #"}
var startPoint = null;       
var ended = false;           
var presentationMode = false;
var currentViewIndex = 0;
var monitorAspectRatio = window.screen.width / window.screen.height;

var finalizeBtn = document.getElementById('finalizeBtn');
var presentationBtn = document.getElementById('presentationBtn');
var saveBtn = document.getElementById('saveBtn');
var clearBtn = document.getElementById('clearBtn');
var imageLoader = document.getElementById('imageLoader');
var settingsLoader = document.getElementById('settingsLoader');
var slidesList = document.getElementById('slidesList');

// Initially, no image loaded, disable most buttons
finalizeBtn.disabled = true;
presentationBtn.disabled = true;
saveBtn.disabled = true;
clearBtn.disabled = true;

imageLoader.addEventListener('change', function(e) {
  var file = e.target.files[0];
  if (file) {
    var url = URL.createObjectURL(file);
    initializeViewer(url);
    finalizeBtn.disabled = false;
    clearBtn.disabled = false;
  }
});

settingsLoader.addEventListener('change', function(e) {
  var file = e.target.files[0];
  if (file) {
    var reader = new FileReader();
    reader.onload = function(ev) {
      var json = JSON.parse(ev.target.result);

      // Reset all before loading from JSON
      resetAll();

      views = (json.views || []).map(function(v,i){
        // If name is not provided, give a default one
        return {
          x: v.x, y: v.y, w: v.w, h: v.h,
          name: v.name || ("Slide " + (i+1))
        };
      });
      ended = true;
      editMode = false;
      drawAll();
      updateSlidesUI();
      
      presentationBtn.disabled = (views.length === 0);
      saveBtn.disabled = (views.length === 0);
    };
    reader.readAsText(file);
  }
});

function initializeViewer(imageUrl) {
  viewer = OpenSeadragon({
    id: "openseadragon",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: {
      type: 'image',
      url: imageUrl
    },
    showNavigationControl: false,
    animationTime: 1.0,
    springStiffness: 5.0,
    gestureSettingsMouse: { 
      scrollToZoom: false, 
      clickToZoom: false, 
      dblClickToZoom: false, 
      dragToPan: false
    }
  });

  viewer.addHandler('open', function() {
    tiledImage = viewer.world.getItemAt(0);
    lockViewer(true);
    setupSelectionHandlers();
    resizeOverlay();
  });

  window.addEventListener('resize', resizeOverlay);

  document.addEventListener('fullscreenchange', function() {
    if (!document.fullscreenElement && presentationMode) {
      presentationMode = false;
      viewer.viewport.goHome(true);
      lockViewer(true);
      // No instructions to show anymore
      viewer.addOnceHandler('animation-finish', function(){
        resizeOverlay(); 
        drawAll();  
      });
    }
  });
}

// Toolbar Buttons
finalizeBtn.addEventListener('click', endEditing);
presentationBtn.addEventListener('click', enterPowerpointMode);
saveBtn.addEventListener('click', saveSettings);
clearBtn.addEventListener('click', resetAll);

// Toggle UI button
var uiVisible = true;
toggleUIBtn.addEventListener('click', function() {
  uiVisible = !uiVisible;
  toolbar.style.display = uiVisible ? 'block' : 'none';
  toggleUIBtn.textContent = uiVisible ? 'Hide UI' : 'Show UI';
});

viewer?.addHandler('canvas-click', function(event) {
  if (presentationMode) {
    event.preventDefaultAction = true;
    nextRegion();
  }
});

document.addEventListener('keydown', function(e) {
  if (e.code === 'KeyC' && e.ctrlKey) {
    resetAll();
  }
  if (presentationMode && views.length > 0) {
    if (e.key === ' ' || e.key === 'ArrowRight') {
      nextRegion();
    } else if (e.key === 'ArrowLeft') {
      prevRegion();
    } else if (e.key === 'Escape') {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        presentationMode = false;
        viewer.viewport.goHome(true);
        lockViewer(true);
        drawAll();
      }
    }
  }
});

function setupSelectionHandlers() {
  viewer.innerTracker.moveHandler = function(event) {
    if (editMode && startPoint) {
      var rect = calculateRectWithAspectRatio(startPoint, event.position);
      drawSelectionRect(rect);
    }
  };

  viewer.innerTracker.pressHandler = function(event) {
    if (editMode) {
      startPoint = event.position; 
    }
  };

  viewer.innerTracker.releaseHandler = function(event) {
    if (editMode && startPoint) {
      var rect = calculateRectWithAspectRatio(startPoint, event.position);
      if (rect.width > 5 && rect.height > 5) {
        var imageRect = screenRectToImageRect(rect, tiledImage, viewer);
        var newName = "Slide " + (views.length+1);
        views.push({x: imageRect.x, y: imageRect.y, w: imageRect.w, h: imageRect.h, name: newName});
        selectionRectElement.style.display = 'none';
        startPoint = null;
        drawAll();
        updateSlidesUI();
      } else {
        selectionRectElement.style.display = 'none';
        startPoint = null; 
      }
    }
  };
}

function lockViewer(lock) {
  viewer.gestureSettingsMouse.dragToPan = !lock;
  viewer.gestureSettingsMouse.scrollToZoom = !lock;
  viewer.gestureSettingsMouse.clickToZoom = !lock;
  viewer.gestureSettingsMouse.dblClickToZoom = !lock;
}

function lockViewerForPresentation() {
  viewer.gestureSettingsMouse.dragToPan = false;
  viewer.gestureSettingsMouse.scrollToZoom = false;
  viewer.gestureSettingsMouse.clickToZoom = false;
  viewer.gestureSettingsMouse.dblClickToZoom = false;
}

function getScreenAspectRatio() {
  return monitorAspectRatio;
}

function calculateRectWithAspectRatio(p1, p2) {
  var aspect = getScreenAspectRatio();
  var x = Math.min(p1.x, p2.x);
  var y = Math.min(p1.y, p2.y);
  var width = Math.abs(p1.x - p2.x);
  var height = Math.abs(p1.y - p2.y);

  var currentRatio = width / height;
  if (currentRatio > aspect) {
    height = width / aspect;
    if (p2.y < p1.y) {
      y = p1.y - height;
    }
  } else {
    width = height * aspect;
    if (p2.x < p1.x) {
      x = p1.x - width;
    }
  }

  return {x: x, y: y, width: width, height: height};
}

function drawSelectionRect(rect) {
  selectionRectElement.style.left = rect.x + 'px';
  selectionRectElement.style.top = rect.y + 'px';
  selectionRectElement.style.width = rect.width + 'px';
  selectionRectElement.style.height = rect.height + 'px';
  selectionRectElement.style.display = 'block';
}

function screenRectToImageRect(screenRect, tiledImage, viewer) {
  var topLeftViewport = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(screenRect.x, screenRect.y), true);
  var bottomRightViewport = viewer.viewport.pointFromPixel(new OpenSeadragon.Point(screenRect.x + screenRect.width, screenRect.y + screenRect.height), true);

  var topLeftImage = tiledImage.viewportToImageCoordinates(topLeftViewport);
  var bottomRightImage = tiledImage.viewportToImageCoordinates(bottomRightViewport);

  return {
    x: topLeftImage.x,
    y: topLeftImage.y,
    w: bottomRightImage.x - topLeftImage.x,
    h: bottomRightImage.y - topLeftImage.y
  };
}

function endEditing() {
  editMode = false;
  ended = true;
  presentationBtn.disabled = (views.length === 0);
  saveBtn.disabled = (views.length === 0);
  drawAll();
}

function drawAll() {
  if (!overlayCtx) return;
  overlayCtx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
  if (!presentationMode && ended) {
    drawConnectingLine();
    eraseLineInsideRectangles();
    drawRectangles();
  } else if (!presentationMode && !ended) {
    drawRectangles();
  }
}

function drawConnectingLine() {
  if (views.length < 2) return; 
  overlayCtx.save();
  overlayCtx.strokeStyle = "red";
  overlayCtx.lineWidth = 2;
  overlayCtx.beginPath();
  for (var i = 0; i < views.length; i++) {
    var center = imageRectCenterToScreen(views[i]);
    if (i === 0) {
      overlayCtx.moveTo(center.x, center.y);
    } else {
      overlayCtx.lineTo(center.x, center.y);
    }
  }
  overlayCtx.stroke();
  overlayCtx.restore();
}

function eraseLineInsideRectangles() {
  overlayCtx.save();
  overlayCtx.globalCompositeOperation = 'destination-out';
  for (var i = 0; i < views.length; i++) {
    var rectScreen = imageRectToScreenRect(views[i]);
    overlayCtx.fillRect(rectScreen.x, rectScreen.y, rectScreen.w, rectScreen.h);
  }
  overlayCtx.restore();
}

function drawRectangles() {
  overlayCtx.save();
  for (var i = 0; i < views.length; i++) {
    var v = views[i];
    var rectScreen = imageRectToScreenRect(v);

    overlayCtx.fillStyle = 'rgba(0, 255, 255, 0.2)'; 
    overlayCtx.fillRect(rectScreen.x, rectScreen.y, rectScreen.w, rectScreen.h);

    overlayCtx.strokeStyle = 'cyan';
    overlayCtx.lineWidth = 2;
    overlayCtx.strokeRect(rectScreen.x, rectScreen.y, rectScreen.w, rectScreen.h);

    var text = v.name || (i+1).toString();
    overlayCtx.font = 'bold 24px sans-serif';
    overlayCtx.lineWidth = 3;
    overlayCtx.strokeStyle = 'black';
    overlayCtx.strokeText(text, rectScreen.x + 10, rectScreen.y + 30);
    overlayCtx.fillStyle = 'yellow';
    overlayCtx.fillText(text, rectScreen.x + 10, rectScreen.y + 30);
  }
  overlayCtx.restore();
}

function imageRectToScreenRect(view) {
  var topLeft = tiledImage.imageToViewportCoordinates(new OpenSeadragon.Point(view.x, view.y));
  var bottomRight = tiledImage.imageToViewportCoordinates(new OpenSeadragon.Point(view.x+view.w, view.y+view.h));
  var topLeftPx = viewer.viewport.pixelFromPoint(topLeft, true);
  var bottomRightPx = viewer.viewport.pixelFromPoint(bottomRight, true);
  return {
    x: topLeftPx.x,
    y: topLeftPx.y,
    w: bottomRightPx.x - topLeftPx.x,
    h: bottomRightPx.y - topLeftPx.y
  };
}

function imageRectCenterToScreen(view) {
  var centerX = view.x + view.w/2;
  var centerY = view.y + view.h/2;
  var imageCenterPoint = new OpenSeadragon.Point(centerX, centerY);
  var viewportPoint = tiledImage.imageToViewportCoordinates(imageCenterPoint);
  var pixelPoint = viewer.viewport.pixelFromPoint(viewportPoint, true);
  return pixelPoint;
}

async function enterPowerpointMode() {
  if (!ended || views.length === 0) return; 
  presentationMode = true;
  if (!document.fullscreenElement) {
    try {
      await document.documentElement.requestFullscreen();
    } catch (err) {
      console.warn("Fullscreen request denied.", err);
    }
  }
  lockViewerForPresentation();
  overlayCtx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
  currentViewIndex = 0;
  showView(views[currentViewIndex]);
}

function showView(view) {
  var imageRect = new OpenSeadragon.Rect(view.x, view.y, view.w, view.h);
  var viewportRect = viewer.viewport.imageToViewportRectangle(imageRect);
  viewer.viewport.fitBounds(viewportRect, false);
}

function resizeOverlay() {
  if (!viewer) return;
  var container = viewer.canvas;
  overlayCanvas.width = container.clientWidth;
  overlayCanvas.height = container.clientHeight;
  drawAll();
}

function resetAll() {
  views = [];
  ended = false;
  editMode = true;
  presentationMode = false;
  presentationBtn.disabled = true;
  saveBtn.disabled = true;
  drawAll();
  if (viewer) {
    viewer.viewport.goHome(true);
  }
  updateSlidesUI();
}

function nextRegion() {
  currentViewIndex = (currentViewIndex + 1) % views.length;
  showView(views[currentViewIndex]);
}

function prevRegion() {
  currentViewIndex = (currentViewIndex - 1 + views.length) % views.length;
  showView(views[currentViewIndex]);
}

function saveSettings() {
  if (!ended || views.length === 0) return;
  var data = JSON.stringify({views: views}, null, 2);
  var blob = new Blob([data], {type: "application/json"});
  var url = URL.createObjectURL(blob);
  
  var a = document.createElement("a");
  a.href = url;
  a.download = "settings.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/**
 * Update Slides UI
 */
function updateSlidesUI() {
  slidesList.innerHTML = '';
  views.forEach((slide, index) => {
    var div = document.createElement('div');
    div.className = 'slide-item';

    var nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = slide.name || ("Slide " + (index+1));
    nameInput.addEventListener('change', function(){
      slide.name = nameInput.value;
      drawAll();
    });

    var ctrlDiv = document.createElement('div');
    ctrlDiv.className = 'slide-controls';

    var upBtn = document.createElement('button');
    upBtn.textContent = '↑';
    upBtn.title = 'Move Up';
    upBtn.addEventListener('click', function(){
      if (index > 0) {
        var temp = views[index];
        views[index] = views[index-1];
        views[index-1] = temp;
        updateSlidesUI();
        drawAll();
      }
    });

    var downBtn = document.createElement('button');
    downBtn.textContent = '↓';
    downBtn.title = 'Move Down';
    downBtn.addEventListener('click', function(){
      if (index < views.length - 1) {
        var temp = views[index];
        views[index] = views[index+1];
        views[index+1] = temp;
        updateSlidesUI();
        drawAll();
      }
    });

    var removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.title = 'Remove Slide';
    removeBtn.addEventListener('click', function(){
      views.splice(index, 1);
      presentationBtn.disabled = (views.length === 0 || !ended);
      saveBtn.disabled = (views.length === 0 || !ended);
      updateSlidesUI();
      drawAll();
    });

    ctrlDiv.appendChild(upBtn);
    ctrlDiv.appendChild(downBtn);
    ctrlDiv.appendChild(removeBtn);

    div.appendChild(nameInput);
    div.appendChild(ctrlDiv);

    slidesList.appendChild(div);
  });
}
</script>
</body>
</html>
